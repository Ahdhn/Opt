**Development Journal** 
		Michael Mara

**2015/12/4 13:59**
AD vs no AD error on the order of a millionth, with the values on the order of tenths to hundredths, even in the shading term case. Will assume floating point error for now.

**2015/12/4 10:43**
Brought the (AD vs no AD) cost in line with what I believe to be floating-point error, even in the shading term case, sans small boundary errors. About to deep-dive into those.

**2015/12/4 9:48**
The error found at the end of the last entry was the biggest problem. Now it seems like (for the no-shading term case) we may be down to floating point error.

**2015/12/3 16:19**
Error persists even when cost is calculated only as sqMagnitude(4.0*p(0,0)). Going to investigate p more.

OOp, think I found it. p() in AD was using the x coordinate twice instead of alterately using the y coord....

**2015/12/3 16:11**
Decided on Tuesday that errors in JTF mismatch are probably from floating point errors. Will sometime check this by making all intermediates in the solvers into doubles. For now working on getting
the costs the same between Opt and the terra implementation. Getting small differences that are spatially coherent, even when only checking regularization term, and with the DEPTH_DISCONTINUITY checks turned off.

**2015/12/01 11:20**
Actually checking in work from Monday and weekend, also changed boundary handling in the terra cost function to match the cuda one. It is super important to make sure boundary handling is the same across all the different implementations (CUDA, Terra, Opt).

**2015/11/30 14:12**
Fixed a lot; one of the big bugs is that every access to the color image (I), does a weird quasi blur. Need to investigate this more. But the current problem to debug is the cost at the border of valid depth is different
for CUDA vs Terra.

**2015/11/30 12:35**
No noticeable difference between CUDA and Terra if comparing only the regularization and depth constraints, so bug is in shading. Also, the masks are (accidentally) already handled correctly.

**2015/11/30 10:52**
CUDA and Terra giving very different results. Weird horizontal NaN problems in CUDA version. Going to bring the terra .imagedump functionality back online to compare the two. Side note: I noticed the masks are uint8s in Terra, but I think we might treat them as uint8s in CUDA... Worth a look.

**2015/11/30 10:36**
As of 11/28, had fixed all the bugs and the initial JTJ for the block and non-block SFS solver gives exact results. Now need to compare Terra and CUDA versions; also need to ask Matthias about the extra x2s.

**2015/11/28 13:54**
Implemented a first attempt at calculating P on the borders in the SFS patch solver. Currently giving old results and not sure why, debugging now...

**2015/11/25 17:24**
The terra block solvers have the same problem! Also, I have verified that with the shading and depth constraint terms added back in, SFS block and non-block CUDA solvers give identical results except on patch boundaries.

**2015/11/25 16:24**
Went through a ton of debugging, fixed some problems reading the wrong buffers and being off by a factor of 2, now only obvious error is on patch boundaries.
After much investigation, realized we never initialize the p values on the boundaries; for *any* of the CUDA block solvers.

**2015/11/25 14:46**

Added image dump support to the non-block CUDA solver for Shape From Shading, and started comparing cost, JTF and JTJ images between the two CUDA solvers.

With only the regularization and depth constraint terms enabled, cost and JTF are identical, while JTJ is very different, the biggest different is on the edges of the valid depths, where the nonblock solver has QNANs and -infinities.

**2015/11/25 11:43**

Documented the .imagedump file format in the main README.

**2015/11/24 16:15**

Initial port of solver done. not giving correct results (shocking!). First thing to do tomorrow is to bring the "imagedump" functionality back online.


**2015/11/24 15:15**

Depth Constraint + Smoothing only
Block: 0.005650
Non-Block: 0.005652

With shading as well (non-block):
7957.30127

Pretty close. I'm going to go ahead and implement the other functions, then get fine-grain comparisons via image dumping.


**2015/11/24 14:53**

After debugging improper warp reductions, I have a cost function for the non-block solver running, but producing results *very* different than the block solver. Time to debug! Tahnkfully I have the ability to turn individual terms off, which should help quite a bit.

**2015/11/24 13:53**

Went down a couple of dead ends while trying to get the non-block solver to work. Reverted some stuff and now going to try to change pieces at a time while checking each change to make sure the blocked solver doesn't change.

Made a small (2 frame) test case to run experiments on. First up is making sure the initial cost is repeatable:

Trial 1: 7955.705078
Trial 2: 7955.706543
Trial 3: 7955.706055

Seems fairly repeatable. What I don't understand is why the first frame always looks so much worse than the rest. (This is true for all of the optimizers and regardless of what the frames actually are (I tried swapping first and second frames to no perceivable difference))



**2015/11/23 17:12**

Gilbert is all set up to work on Opt! Beyond that, struggled through getting the CUDA non-patch solver to not crash, rewrote it to use warp reductions, found null pointers, etc. Now ready to start slotting in the SFS code.


**2015/11/23 15:48**

Stalled progress on non-blocked SFS, but had a very productive series of meetings with Matthias + Gilbert about fast solving strategies 
(specifically, the idea, proposed by Gilbert, that we should materialize the matrix coefficients at the start of each non-linear 
iteration and just apply the matrix repeatedly for PCG).

**2015/11/23 13:42**

Tested non-blocked versions of both terra and terra AD solver. Terra version seems same as blocked, AD version is definitely not correct, but seems to propagate NaNs less strongly than the non-blocked version. 

Fixing the AD version is still an open issue.

Added in the framework for a non-blocked CUDA solver by copying over files from PoissonImageEditing and adding plumbing code so that we can call it in place of the other solvers.
Currently tracking down an issue where there are illegal memory accesses, despite the fact I stripped out most of the code that should be doing anything. Solving this and then slowly implementing full functionality to
bring it on par with the blocked solver are my highest priorities.


**2015/11/20 16:42**

Brought all versions of ShapeFromShading online. Current status:

CUDA (block solver only): *Increases* cost
Terra: Seems to work fairly well
Terra AD: NaNs are propagating.

Things to do next: switch terra versions to non-blocked version. Write non-blocked CUDA version. Debug AD version.

**2015/11/20 15:27**

Added areWeBroken.sh, which is meant to be a one-button regression test. Right now, just compiles and runs the known-good samples.

Working towards getting Shape From Shading online, added new documentation to aid future versions of myself in that process.


<!-- Markdeep: --><style class="fallback">body{white-space:pre;font-family:monospace}</style><script src="markdeep.min.js"></script><script src="http://casual-effects.com/markdeep/latest/markdeep.min.js"></script>